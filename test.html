<html>
	<head>
		<title>test</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
		<style>body {
    margin: 0;
    padding: 0;
    font: 14px/1.5 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    color: #252519;
}
a {
    color: #252519;
}
a:hover {
    text-decoration: underline;
    color: #19469D;
}
p {
    margin: 12px 0;
}
h1, h2, h3 {
    margin: 0;
    padding: 0;
}
table#source {
    width: 100%;
    border-collapse: collapse;
}
table#source td:first-child {
    padding: 30px 40px 30px 40px;
    vertical-align: top;
}
table#source td:first-child,
table#source td:first-child pre {
    width: 450px;
}
table#source td:last-child {
    padding: 30px 0 30px 40px;
    border-left: 1px solid #E5E5EE;
    background: #F5F5FF;
}
table#source tr {
    border-bottom: 1px solid #E5E5EE;
}
table#source tr.filename {
    padding-top: 40px;
    border-top: 1px solid #E5E5EE;
}
table#source tr.filename td:first-child {
    text-transform: capitalize;
}
table#source tr.filename td:last-child {
    font-size: 12px;
}
table#source tr.filename h2 {
    margin: 0;
    padding: 0;
    cursor: pointer;
}
table#source tr.code h1,
table#source tr.code h2,
table#source tr.code h3 {
    margin-top: 30px;
    font-family: "Lucida Grande", "Helvetica Nueue", Arial, sans-serif;
    font-size: 18px;
}
table#source tr.code h2 {
    font-size: 16px;
}
table#source tr.code h3 {
    font-size: 14px;
}
table#source tr.code ul {
    margin: 15px 0 15px 35px;
    padding: 0;
}
table#source tr.code ul li {
    margin: 0;
    padding: 1px 0;
}
table#source tr.code ul li p {
    margin: 0;
    padding: 0;
}
table#source tr.code td:first-child pre {
    padding: 20px;
}
#ribbon {
    position: fixed;
    top: 0;
    right: 0;
}
code .string { color: #219161; }
code .regexp { color: #219161; }
code .keyword { color: #954121; }
code .number { color: #19469D; }
code .comment { color: #bbb; }
code .this { color: #19469D; }</style>
		<script>
			$(function(){
				$('tr.code').hide();
				$('tr.filename').toggle(function(){
					$(this).nextUntil('.filename').fadeIn();
				}, function(){
					$(this).nextUntil('.filename').fadeOut();
				});
			});
		</script>
	</head>
	<body>
<table id="source"><tbody><tr><td><h1>test</h1></td><td></td></tr><tr class="filename"><td><h2 id="app.js"><a href="#">app</a></h2></td><td>app.js</td></tr><tr class="code">
<td class="docs">
<p>Module dependencies
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">express</span> = <span class="variable">require</span>(<span class="string">'express'</span>);

<span class="keyword">var</span> <span class="variable">app</span> = <span class="variable">module</span>.<span class="variable">exports</span> = <span class="variable">express</span>.<span class="variable">createServer</span>();
<span class="keyword">var</span> <span class="variable">request</span> = <span class="variable">require</span>(<span class="string">'request'</span>);
 
<span class="keyword">var</span> <span class="variable">twapperlyzerCache</span> = <span class="variable">require</span>(<span class="string">'./twapper_modules/twapperlyzerCache.js'</span>)</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module Configuration
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">port</span> = (<span class="variable">process</span>.<span class="variable">env</span>.<span class="class">PORT</span> || <span class="number integer">3000</span>);
<span class="keyword">var</span> <span class="variable">maxMessages</span> = <span class="number integer">200</span>;
<span class="keyword">var</span> <span class="variable">firstMsgsToShow</span>=<span class="number integer">5</span>;
<span class="keyword">var</span> <span class="variable">expireTime</span> = <span class="number integer">60000</span>*<span class="number integer">30</span>;

<span class="variable">app</span>.<span class="variable">configure</span>(<span class="keyword">function</span>(){
  <span class="variable">app</span>.<span class="variable">set</span>(<span class="string">'views'</span>, <span class="variable">__dirname</span> + <span class="string">'/views'</span>);
  <span class="variable">app</span>.<span class="variable">set</span>(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);
  <span class="comment">//app.use(express.logger({ format: ':method :url' }));</span>
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">bodyParser</span>());
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">cookieParser</span>());
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">methodOverride</span>());
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">app</span>.<span class="variable">router</span>);
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">static</span>(<span class="variable">__dirname</span> + <span class="string">'/public'</span>));
});

<span class="variable">app</span>.<span class="variable">configure</span>(<span class="string">'development'</span>, <span class="keyword">function</span>(){
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">errorHandler</span>({ <span class="variable">dumpExceptions</span>: <span class="variable">true</span>, <span class="variable">showStack</span>: <span class="variable">true</span> })); 
});

<span class="variable">app</span>.<span class="variable">configure</span>(<span class="string">'production'</span>, <span class="keyword">function</span>(){
  <span class="variable">app</span>.<span class="variable">use</span>(<span class="variable">express</span>.<span class="variable">errorHandler</span>()); 
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Module Globals
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">cache</span> = <span class="keyword">new</span> <span class="variable">twapperlyzerCache</span>.<span class="class">TwapperlyzerCache</span>(<span class="variable">expireTime</span>);</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<h2>Express Routes</h2>

<p> </p>
</td>
<td class="code">

</td>
</tr>
<tr class="code">
<td class="docs">
<p> The static JQM page that load all the client side JS code.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">get</span>(<span class="string">'/'</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>){
<span class="variable">res</span>.<span class="variable">sendfile</span>(<span class="string">'public/index.html'</span>);
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p> The Request set the cockie to save the yourTwapperKeeper instance on the client side.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">post</span>(<span class="string">'/ytkURLCookie'</span>, <span class="keyword">function</span>(<span class="variable">req</span>, <span class="variable">res</span>){
  <span class="comment">//it is in req.body since its post, if it would be a get the data would be in req.query</span>
  <span class="variable">res</span>.<span class="variable">cookie</span>(<span class="string">'ytkURL'</span>, <span class="variable">req</span>.<span class="variable">body</span>.<span class="variable">ytkURL</span>);
  <span class="variable">res</span>.<span class="variable">send</span>(&<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;);
  <span class="comment">//res.send(JSON.stringify(myresponse)); </span>
});</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p> Binding the port an load NowJS
 </p>
</td>
<td class="code">
<pre><code><span class="variable">app</span>.<span class="variable">listen</span>(<span class="variable">port</span>);
<span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'Twaperlizer server listening on port http://0.0.0.0:%d'</span>, <span class="variable">app</span>.<span class="variable">address</span>().<span class="variable">port</span>);
<span class="keyword">var</span> <span class="variable">everyone</span> = <span class="variable">require</span>(<span class="string">'now'</span>).<span class="variable">initialize</span>(<span class="variable">app</span>);
 



<span class="comment">//apiListArchivesUrl = url+ &quot;apiListArchives.php&quot;;</span>
<span class="comment">//apiGetTweetsUrl = url+ &quot;apiGetTweets.php&quot;;</span></code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p> A simple Object to tranport the status of action
 </p>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="class">ResponseBean</span>(){
  <span class="this">this</span>.<span class="variable">status</span>;
  <span class="this">this</span>.<span class="variable">data</span>;
  <span class="this">this</span>.<span class="variable">msg</span>;
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Load the selectedArchive from the net or the cache.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  selectedArchive The selected archive of the user</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>ResponseBean</code>)</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">getArchive</span> = <span class="keyword">function</span> (<span class="variable">selectedArchive</span>, <span class="variable">callback</span>){
  <span class="keyword">var</span> <span class="variable">that</span> = <span class="this">this</span>;

  <span class="variable">selectedArchive</span>.<span class="variable">totalMsgCount</span> = <span class="variable">selectedArchive</span>.<span class="variable">limit</span>;
  <span class="variable">selectedArchive</span>.<span class="variable">staticURLPart</span> = <span class="this">this</span>.<span class="variable">now</span>.<span class="variable">ytkURL</span>+ <span class="string">'apiGetTweets.php'</span>;
  
  <span class="comment">//Deside the case</span>
  <span class="keyword">if</span>(<span class="variable">selectedArchive</span>.<span class="variable">isSearch</span>){
    <span class="variable">archiveDownload</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">callback</span>);
  }<span class="keyword">else</span>{
    <span class="keyword">if</span>(<span class="variable">cache</span>.<span class="variable">isInCache</span>(<span class="this">this</span>.<span class="variable">now</span>.<span class="variable">ytkURL</span>, <span class="variable">selectedArchive</span>.<span class="variable">id</span>)){
      <span class="variable">getArchiveFromCache</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="this">this</span>.<span class="variable">now</span>.<span class="variable">ytkURL</span>, <span class="variable">callback</span>);
    }<span class="keyword">else</span>{
      <span class="variable">archiveDownload</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">callback</span>);
    }
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Load the selectedArchive from the net, after getting the archive info and the 
first couple of messages it returns it to the client and download the remaing. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  that The this scope of the getArchive function</p></li><li><p><strong>param</strong>: <em>Object</em>  selectedArchive The selected archive of the user</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>ResponseBean</code>) Comes from the getArchive function.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">archiveDownload</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">callback</span>){
  <span class="keyword">var</span> <span class="variable">url</span> = <span class="variable">selectedArchive</span>.<span class="variable">staticURLPart</span>+<span class="variable">selectedArchive</span>.<span class="variable">url</span>+<span class="string">'&amp;l='</span>+<span class="class">Math</span>.<span class="variable">min</span>(<span class="variable">selectedArchive</span>.<span class="variable">limit</span>,<span class="variable">maxMessages</span>);
  <span class="comment">//Get the First results to show the user something</span>
  <span class="variable">pGetJSON</span>(<span class="variable">url</span>,<span class="keyword">function</span>(<span class="variable">jsondata</span>){
    <span class="keyword">if</span>(<span class="variable">jsondata</span>.<span class="variable">status</span> == &<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;){
      <span class="comment">//Saving the if it is a Search or not to decide if it belongs in cache</span>
      <span class="variable">jsondata</span>.<span class="variable">data</span>.<span class="variable">archive_info</span>.<span class="variable">noCache</span> = <span class="variable">selectedArchive</span>.<span class="variable">isSearch</span>;
      <span class="comment">//Return the First results</span>
      <span class="variable">setUpCallback</span>(<span class="variable">jsondata</span>.<span class="variable">data</span>, (<span class="variable">selectedArchive</span>.<span class="variable">limit</span>&<span class="variable">lt</span>;<span class="variable">maxMessages</span>),<span class="variable">callback</span>);
    }<span class="keyword">else</span>{
      <span class="variable">gettingArchiveFaild</span>(<span class="variable">jsondata</span>);
    }
    
    <span class="comment">//If the archive is bigger download the missing</span>
    <span class="keyword">if</span>(<span class="variable">selectedArchive</span>.<span class="variable">limit</span>&<span class="variable">gt</span>;<span class="variable">maxMessages</span>){
      <span class="comment">//substract the allready downloaded messages from the total</span>
      <span class="variable">selectedArchive</span>.<span class="variable">limit</span> = <span class="variable">selectedArchive</span>.<span class="variable">limit</span> -<span class="variable">maxMessages</span>;
      <span class="variable">getTheMissingMsgs</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">jsondata</span>.<span class="variable">data</span>);
    
    }<span class="keyword">else</span>{
       <span class="variable">archiveReady</span>(<span class="variable">that</span>,<span class="variable">jsondata</span>.<span class="variable">data</span>);
    }
  });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Load the selectedArchive from the cache and returns it to the client. 
After getting the archive from the cache it make sure that it's still up to 
date. If not it will download the remaing. </p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  that The this scope of the getArchive Function</p></li><li><p><strong>param</strong>: <em>Object</em>  selectedArchive The selected archive of the user</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>ResponseBean</code>) Comes from the getArchive Function.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getArchiveFromCache</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">ytkURL</span>, <span class="variable">callback</span>){
  <span class="keyword">var</span> <span class="variable">archiveFromCache</span> = <span class="variable">cache</span>.<span class="variable">getFromCache</span>(<span class="variable">ytkURL</span>, <span class="variable">selectedArchive</span>.<span class="variable">id</span>);
  <span class="keyword">if</span>(<span class="variable">archiveFromCache</span>.<span class="variable">archive_info</span>.<span class="variable">count</span> == <span class="variable">selectedArchive</span>.<span class="variable">limit</span>){
    <span class="comment">//The easy case just return the cached result.</span>
    <span class="variable">setUpCallback</span>(<span class="variable">archiveFromCache</span>, <span class="variable">true</span>, <span class="variable">callback</span>);
    <span class="variable">archiveFromCache</span>.<span class="variable">archive_info</span>.<span class="variable">noCache</span> = <span class="variable">true</span>;
    <span class="variable">archiveReady</span>(<span class="variable">that</span>, <span class="variable">archiveFromCache</span>);
  }<span class="keyword">else</span>{
    <span class="comment">//FIXME This is still untested </span>
    <span class="comment">//The Version from the cache has to be updated</span>
    
    <span class="comment">//substract the allready cached messages from the total</span>
    <span class="variable">selectedArchive</span>.<span class="variable">limit</span> = <span class="variable">selectedArchive</span>.<span class="variable">limit</span> -<span class="variable">archiveFromCache</span>.<span class="variable">archive_info</span>.<span class="variable">count</span>;
    
    <span class="comment">//First return the cached results</span>
    <span class="variable">setUpCallback</span>(<span class="variable">archiveFromCache</span>, <span class="variable">false</span>, <span class="variable">callback</span>);
    
    <span class="variable">getTheMissingMsgs</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">archiveFromCache</span>);
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Augment the incomplte archive with messages from the net, 
put it in the cache and inform the client.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  that The this scope of the getArchive Function</p></li><li><p><strong>param</strong>: <em>Object</em>  selectedArchive The selected archive of the user</p></li><li><p><strong>param</strong>: <em>Object</em>  savedArchive The incomplete archive.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getTheMissingMsgs</span>(<span class="variable">that</span>, <span class="variable">selectedArchive</span>, <span class="variable">savedArchive</span>){
  <span class="comment">//Get the missing Messages</span>
  <span class="keyword">var</span> <span class="variable">savedMsgs</span> = <span class="keyword">new</span> <span class="class">ResponseBean</span>();
  <span class="variable">savedMsgs</span>.<span class="variable">data</span> = <span class="variable">savedArchive</span>.<span class="variable">tweets</span>
  <span class="variable">getMoreMsgs</span>(<span class="variable">selectedArchive</span>,<span class="variable">savedMsgs</span>,<span class="keyword">function</span>(<span class="variable">msgs</span>){
    <span class="keyword">if</span>(<span class="variable">msgs</span>.<span class="variable">status</span>==&<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;){
      <span class="variable">savedArchive</span>.<span class="variable">tweets</span> = <span class="variable">msgs</span>.<span class="variable">data</span>;
      <span class="variable">archiveReady</span>(<span class="variable">that</span>, <span class="variable">savedArchive</span>);
    }<span class="keyword">else</span>{
      <span class="variable">gettingArchiveFaild</span>(<span class="variable">msgs</span>);
    }
  });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Build and prepare a <code>ResponseBean</code> with the archive info and the 
first couple of messages. Finnaly send it back to the client.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  archive The ytk archive</p></li><li><p><strong>param</strong>: <em>Boolean</em>  isComplete True if the archive is allready complete</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>ResponseBean</code>) Comes from the getArchive Function.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">setUpCallback</span>(<span class="variable">archive</span>, <span class="variable">isComplete</span>, <span class="variable">callback</span>){
  <span class="keyword">var</span> <span class="variable">myresponse</span> = <span class="keyword">new</span> <span class="class">ResponseBean</span>();

  <span class="keyword">var</span> <span class="variable">fakeArchive</span> = <span class="keyword">new</span> <span class="class">Object</span>();
  <span class="comment">//need a empty arry to copy the first messages</span>
  <span class="variable">fakeArchive</span>.<span class="variable">tweets</span>= <span class="keyword">new</span> <span class="class">Array</span>();
  <span class="variable">myresponse</span>.<span class="variable">data</span> = <span class="variable">fakeArchive</span>;
  <span class="variable">myresponse</span>.<span class="variable">status</span> = &<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;;
  <span class="variable">myresponse</span>.<span class="variable">data</span>.<span class="variable">archive_info</span> = <span class="variable">archive</span>.<span class="variable">archive_info</span>;
  
  <span class="comment">//other wise the loop might fail</span>
  <span class="keyword">if</span>(<span class="variable">archive</span>.<span class="variable">tweets</span> == <span class="keyword">null</span>){
    <span class="variable">archive</span>.<span class="variable">tweets</span> = <span class="keyword">new</span> <span class="class">Array</span>();
  }
  
  <span class="comment">//Copy the first messages to save bandwidth</span>
  <span class="keyword">for</span>(<span class="keyword">var</span> <span class="variable">i</span>=<span class="number integer">0</span>; <span class="variable">i</span>&<span class="variable">lt</span>;<span class="class">Math</span>.<span class="variable">min</span>(<span class="variable">firstMsgsToShow</span>,<span class="variable">archive</span>.<span class="variable">tweets</span>.<span class="variable">length</span>); <span class="variable">i</span>++){
    <span class="variable">myresponse</span>.<span class="variable">data</span>.<span class="variable">tweets</span>[<span class="variable">i</span>]=<span class="variable">archive</span>.<span class="variable">tweets</span>[<span class="variable">i</span>];
  }
  
  <span class="keyword">if</span>(!<span class="variable">isComplete</span>){
    <span class="variable">myresponse</span>.<span class="variable">data</span>.<span class="variable">archive_info</span>.<span class="variable">count</span> = &<span class="variable">quot</span>;-&<span class="variable">quot</span>;;
  }

  <span class="variable">callback</span>(<span class="variable">myresponse</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Save the archive in the now.user space and in the cache, inform the client 
that the archive is now saved.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Object</em>  that The this scope of the getArchive Function</p></li><li><p><strong>param</strong>: <em>Object</em>  archive The complete archive.</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">archiveReady</span>(<span class="variable">that</span>, <span class="variable">archive</span>){
  <span class="comment">//Correct the length in the info</span>
  <span class="variable">archive</span>.<span class="variable">archive_info</span>.<span class="variable">count</span> = <span class="variable">archive</span>.<span class="variable">tweets</span>.<span class="variable">length</span>;
  <span class="comment">//Save the final whole archive in the userspace</span>
  <span class="variable">that</span>.<span class="variable">user</span>.<span class="variable">jsonCurrentArchive</span> = <span class="variable">archive</span>;
  
  <span class="comment">// If it is no seach add it to the cache, it dosen't make sense to cache searches</span>
  <span class="keyword">if</span>(!<span class="variable">archive</span>.<span class="variable">archive_info</span>.<span class="variable">noCache</span>){
    <span class="variable">cache</span>.<span class="variable">addToCache</span>(<span class="variable">that</span>.<span class="variable">now</span>.<span class="variable">ytkURL</span>, <span class="variable">archive</span>);
  }

  <span class="comment">//Also update the length info and the download progrss on the client side</span>
  <span class="variable">that</span>.<span class="variable">now</span>.<span class="variable">jsonCurrentArchive</span>.<span class="variable">archive_info</span>.<span class="variable">count</span> = <span class="variable">archive</span>.<span class="variable">tweets</span>.<span class="variable">length</span>;
  <span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">sendDownloadProgress</span>(<span class="number integer">100</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Is called when getting the Archive faild and handle the error.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em><code>ResponseBean</code></em>  err</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">gettingArchiveFaild</span>(<span class="variable">err</span>){
  <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'gettingArchiveFaild'</span>, <span class="variable">err</span>.<span class="variable">status</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Dowload recursive a archive and return the tweets in the callback
## </p>

<ul><li><p><strong>param</strong>: <em>Object</em>  selectedArchive The selected archive of the user</p></li><li><p><strong>param</strong>: <em><code>ResponseBean</code></em>  msgs The part of the messages that are allready downloded</p></li><li><p><strong>param</strong>: <em><code>Function</code></em>  callback(<code>ResponseBean</code>) the complete set of messages or the error</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getMoreMsgs</span>(<span class="variable">selectedArchive</span>, <span class="variable">msgs</span>, <span class="variable">callback</span>){
  <span class="keyword">if</span>(<span class="variable">selectedArchive</span>.<span class="variable">limit</span>&<span class="variable">gt</span>;<span class="number integer">0</span>){
  
    <span class="comment">//sending the Download progress</span>
    <span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">sendDownloadProgress</span>(<span class="variable">getProgessInPercent</span>(<span class="variable">selectedArchive</span>.<span class="variable">limit</span>,<span class="variable">selectedArchive</span>.<span class="variable">totalMsgCount</span>));
    
    <span class="comment">//Limit should decrise with each recusion step and in the last Step be smaller than maxMessages </span>
    <span class="comment">//this is only importend when the user did a search with specific limit.</span>
    <span class="keyword">var</span> <span class="variable">urlLimit</span> = <span class="class">Math</span>.<span class="variable">min</span>(<span class="variable">selectedArchive</span>.<span class="variable">limit</span>,<span class="variable">maxMessages</span>);
    
    <span class="comment">//The max Id is needed so that the next download start where the last ended.</span>
    <span class="variable">selectedArchive</span>.<span class="variable">max_id</span> = (<span class="variable">msgs</span>.<span class="variable">data</span>[<span class="variable">msgs</span>.<span class="variable">data</span>.<span class="variable">length</span>-<span class="number integer">1</span>].<span class="variable">id</span>);
    
    <span class="keyword">var</span> <span class="variable">url</span> = <span class="variable">selectedArchive</span>.<span class="variable">staticURLPart</span>+<span class="variable">selectedArchive</span>.<span class="variable">url</span>+&<span class="variable">quot</span>;&<span class="variable">amp</span>;<span class="variable">l</span>=&<span class="variable">quot</span>;+<span class="variable">urlLimit</span>+&<span class="variable">quot</span>;&<span class="variable">amp</span>;<span class="variable">max_id</span>=&<span class="variable">quot</span>;+<span class="variable">selectedArchive</span>.<span class="variable">max_id</span>;
    <span class="variable">pGetJSON</span>(<span class="variable">url</span>,<span class="keyword">function</span>(<span class="variable">jsondata</span>){
          <span class="keyword">if</span>(<span class="variable">jsondata</span>.<span class="variable">status</span> == &<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;){
            <span class="variable">msgs</span>.<span class="variable">status</span> = <span class="variable">jsondata</span>.<span class="variable">status</span>;
            <span class="variable">msgs</span>.<span class="variable">data</span> = <span class="variable">msgs</span>.<span class="variable">data</span>.<span class="variable">concat</span>(<span class="variable">jsondata</span>.<span class="variable">data</span>.<span class="variable">tweets</span>);
            <span class="comment">//Decrising the amount of messages that still need to get downloaded </span>
            <span class="variable">selectedArchive</span>.<span class="variable">limit</span>=<span class="variable">selectedArchive</span>.<span class="variable">limit</span>-<span class="variable">maxMessages</span>;
            <span class="variable">getMoreMsgs</span>(<span class="variable">selectedArchive</span>, <span class="variable">msgs</span>,<span class="variable">callback</span>);
          }
          <span class="keyword">else</span>{
          <span class="variable">callback</span>(<span class="variable">jsondata</span>);
          }
    });
  }<span class="keyword">else</span>{
    <span class="variable">callback</span>(<span class="variable">msgs</span>);
  }
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Dowload recursive a archive and return the tweets in the callback
## </p>

<ul><li><p><strong>param</strong>: <em>Number</em>  percentage</p></li><li><p><strong>param</strong>: <em>Number</em>  base</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">function</span> <span class="variable">getProgessInPercent</span>(<span class="variable">percentage</span>,<span class="variable">base</span>){
  <span class="keyword">return</span> <span class="class">Math</span>.<span class="variable">floor</span>(<span class="number integer">100</span>-(<span class="regexp">/(base/</span><span class="number integer">100</span>)));
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>A dummy function to get debug values to the client.
## </p>

<ul><li><p><strong>param</strong>: <em>Function</em>  callback</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">msgAmount</span> = <span class="keyword">function</span> (<span class="variable">callback</span>){
<span class="variable">callback</span>(<span class="this">this</span>.<span class="variable">user</span>.<span class="variable">jsonCurrentArchive</span>.<span class="variable">tweets</span>.<span class="variable">length</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Call a function on the client to update the download progress bar.
## </p>

<ul><li><p><strong>param</strong>: <em>Number</em>  percent</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">sendDownloadProgress</span> = <span class="keyword">function</span> (<span class="variable">percent</span>){
<span class="this">this</span>.<span class="variable">now</span>.<span class="variable">updateDowloadSlider</span>(<span class="variable">percent</span>);
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Copy messages from this.user space to the this.now space. To make them 
available on the client side.</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>Number</em>  from</p></li><li><p><strong>param</strong>: <em>Number</em>  to</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>String</code>)</p></li></ul>
</td>
<td class="code">
<pre><code><span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">getMsgs</span> = <span class="keyword">function</span>(<span class="variable">from</span>, <span class="variable">to</span>, <span class="variable">callback</span>){
  <span class="keyword">for</span>(<span class="variable">from</span>; <span class="variable">from</span>&<span class="variable">lt</span>;<span class="class">Math</span>.<span class="variable">min</span>(<span class="variable">to</span>,<span class="this">this</span>.<span class="variable">user</span>.<span class="variable">jsonCurrentArchive</span>.<span class="variable">tweets</span>.<span class="variable">length</span>); <span class="variable">from</span>++){
    <span class="this">this</span>.<span class="variable">now</span>.<span class="variable">jsonCurrentArchive</span>.<span class="variable">tweets</span>[<span class="variable">from</span>] = <span class="this">this</span>.<span class="variable">user</span>.<span class="variable">jsonCurrentArchive</span>.<span class="variable">tweets</span>[<span class="variable">from</span>]
  }
  <span class="variable">callback</span>(&<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;);
};</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Get JSON Data over the net</p>

<h2></h2>

<ul><li><p><strong>param</strong>: <em>String</em>  url</p></li><li><p><strong>param</strong>: <em>Function</em>  callback(<code>ResponseBean</code>)</p></li></ul>
</td>
<td class="code">
<pre><code><span class="keyword">var</span> <span class="variable">pGetJSON</span> = <span class="keyword">function</span> (<span class="variable">url</span>,<span class="variable">callback</span>){
  <span class="comment">//console.log(&quot;try to reach: &quot;, url);</span>
  <span class="variable">request</span>({ <span class="variable">uri</span>:<span class="variable">url</span> }, <span class="keyword">function</span> (<span class="variable">error</span>, <span class="variable">response</span>, <span class="variable">body</span>) {
    <span class="keyword">var</span> <span class="variable">myresponse</span> = <span class="keyword">new</span> <span class="class">ResponseBean</span>();
    <span class="keyword">if</span> (<span class="variable">error</span> &<span class="variable">amp</span>;&<span class="variable">amp</span>; <span class="variable">response</span>.<span class="variable">statusCode</span> !== <span class="number integer">200</span>) {
      <span class="variable">myresponse</span>.<span class="variable">status</span> = &<span class="variable">quot</span>;<span class="variable">error</span>&<span class="variable">quot</span>;;
      <span class="variable">myresponse</span>.<span class="variable">msg</span> = &<span class="variable">quot</span>;<span class="class">Could</span> <span class="variable">not</span> <span class="variable">connect</span> <span class="variable">to</span>: &<span class="variable">quot</span>;+<span class="variable">url</span>;
    }
    <span class="keyword">if</span>(<span class="variable">body</span>[<span class="number integer">0</span>]==&<span class="variable">quot</span>;{&<span class="variable">quot</span>; || <span class="variable">body</span>[<span class="number integer">0</span>]==&<span class="variable">quot</span>;[&<span class="variable">quot</span>;){
      <span class="variable">myresponse</span>.<span class="variable">status</span> = &<span class="variable">quot</span>;<span class="variable">ok</span>&<span class="variable">quot</span>;;
      <span class="keyword">try</span> {
        <span class="variable">myresponse</span>.<span class="variable">data</span> = <span class="class">JSON</span>.<span class="variable">parse</span>(<span class="variable">body</span>);
      } <span class="keyword">catch</span> (<span class="variable">err</span>) {
        <span class="variable">myresponse</span>.<span class="variable">status</span> = &<span class="variable">quot</span>;<span class="variable">error</span>&<span class="variable">quot</span>;;
        <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'GetJSON Error'</span>, <span class="variable">err</span>);
        <span class="variable">myresponse</span>.<span class="variable">msg</span> = <span class="string">'Can not parse JSON :'</span>;
      }
    }
    <span class="keyword">else</span>{
      <span class="variable">myresponse</span>.<span class="variable">status</span> = &<span class="variable">quot</span>;<span class="variable">error</span>&<span class="variable">quot</span>;;
      <span class="variable">myresponse</span>.<span class="variable">msg</span> = &<span class="variable">quot</span>;<span class="class">JSON</span> <span class="variable">not</span> <span class="variable">valid</span>: &<span class="variable">quot</span>;;
    }
    <span class="variable">console</span>.<span class="variable">log</span>(<span class="string">'JSON response: '</span>, <span class="variable">myresponse</span>.<span class="variable">status</span>, <span class="string">'for: '</span>,<span class="variable">url</span>);
    <span class="variable">callback</span>(<span class="variable">myresponse</span>);
  });
}</code></pre>
</td>
</tr>
<tr class="code">
<td class="docs">
<p>Making the pGetJSON function available in the everyone.now space,
so that it is callable from the client side.
 </p>
</td>
<td class="code">
<pre><code><span class="variable">everyone</span>.<span class="variable">now</span>.<span class="variable">getJSON</span> = <span class="variable">pGetJSON</span>;



</code></pre>
</td>
</tr>	</body>
</html></tbody></table>